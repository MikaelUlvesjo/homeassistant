action:
  - action: nordpool.get_prices_for_date
    data:
      config_entry: !input nordpool_config
      date: "{{ now().date() }}"
    response_variable: daily_data

  - variables:
      # 1. Dynamically find the region key and extract only the numeric 'price' values
      #    and convert from ORE to KR by dividing by 100
      prices_raw: >
        {% set region = daily_data.keys() | first %}
        {% set data = namespace(values=[]) %}
        {% for item in daily_data[region] %}
          {% set converted_price = item.price | float(0) / 100 %}
          {% set data.values = data.values + [converted_price] %}
        {% endfor %}
        {{ data.values }}
      
      # 2. Determine if current resolution is 15-min (96 values) or hourly (24 values)
      #    Home Assistant handles the local timezone offset automatically using 'now()'
      idx: >
        {% if prices_raw | length > 24 %}
          {{ (now().hour * 4) + (now().minute // 15) }}
        {% else %}
          {{ now().hour }}
        {% endif %}
      
      # 3. Get current price with a safety fallback
      price: "{{ prices_raw[idx | int] | float(0) if (idx | int) < (prices_raw | length) else prices_raw[-1] | float(0) }}"
      
      # 4. Sorting and Ranking
      sorted_prices: "{{ prices_raw | sort }}"
      above_low: "{{ price - sorted_prices }}"
      diff: "{{ sorted_prices[-1] - sorted_prices }}"
      ratio: "{{ ( (above_low / diff) * 100 ) | round if diff > 0 else 0 }}"
      rank: "{{ sorted_prices.index(price) + 1 }}"
      
      # 5. Decision Logic (All inputs are now compared against KR/kWh prices)
      condition_rank: "{{ rank | int <= (hour_rank_input | float * (prices_raw | length / 24)) | int }}"
      seton: >
        {{ price <= (allways_on_var | float(0)) or 
           (ratio | int <= hour_ratio_var | int) or 
           condition_rank }}
      result: "{{ price < (allways_off_var | float(0)) and seton }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ result }}"
        sequence: !input turnon
    default: !input turnoff
